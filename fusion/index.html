<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.3/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Tezumie/Image-to-Pixel@main/image-to-pixel.js"></script>
</head>

<body>
    <script>
        let buffer;
        let spots = [];
        const gridSize = 50;
        const baseSpotSize = 10;
        const mouseSpotSize = 80;
        const scaleFactor = 0.5;
        const reach = 100;
        const enlargeRatio = 10;
        const maxSpeed = 8;
        let cursor;

        function setup() {
            createCanvas(600, 600, WEBGL);

            buffer = createGraphics(width * scaleFactor, height * scaleFactor);
            buffer.noStroke();

            for (let x = gridSize / 2; x < width; x += gridSize) {
                for (let y = gridSize / 2; y < height; y += gridSize) {
                    spots.push({ x, y });
                }
            }
            cursor = createVector(width / 2, height / 2);
        }

        function draw() {
            background(0);

            buffer.background(0);
            const toBuffer = (val) => val * scaleFactor;
            buffer.fill(255);

            const distance = dist(cursor.x, cursor.y, mouseX, mouseY);
            speed = map(Math.min(distance, 100), 0, 100, 0, maxSpeed);
            cursor.add(p5.Vector.sub(createVector(mouseX, mouseY), cursor).setMag(speed));

            const mx = toBuffer(cursor.x);
            const my = toBuffer(cursor.y);

            spots.forEach(spot => {
                const bx = toBuffer(spot.x);
                const by = toBuffer(spot.y);
                const distance = dist(bx, by, mx, my);
                const proximity = map(
                    Math.min(distance, reach * scaleFactor),
                    0, reach * scaleFactor,
                    enlargeRatio, 1,
                    true
                );
                const size = baseSpotSize * scaleFactor * proximity;
                buffer.ellipse(bx, by, size, size);
            });

            buffer.filter(BLUR, 3 * scaleFactor);
            // buffer.filter(BLUR, 10 * scaleFactor);
            buffer.filter(THRESHOLD);

            image(buffer, -width / 2, -height / 2, width, height);
        }
    </script>
</body>

</html>